<!doctype html>
<html>

<head>
  <title>chat</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font: 13px Helvetica, Arial;
    }
    form {
      background: #000;
      padding: 3px;
      position: fixed;
      bottom: 0;
      width: 100%;
    }
    form input {
      border: 0;
      padding: 10px;
      width: 90%;
      margin-right: .5%;
    }
    form button {
      width: 9%;
      background: rgb(130, 224, 255);
      border: none;
      padding: 10px;
    }
    #messages {
      list-style-type: none;
      margin: 0;
      padding: 0;
    }
    #messages li {
      padding: 5px 10px;
    }
    #messages li:nth-child(odd) {
      background: #eee;
    }
  </style>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>

<body>
  <button onclick="printTidligereBeskeder()">klik her xd</button>

  <select id="friendslist" onchange="vaeglVen()">

  </select>
  <ul id="messages"></ul>

  <form action="">
    <input id="m" autocomplete="off" /><button>Send</button>
  </form>



  <script src="/socket.io/socket.io.js"></script>
  <script src="https://code.jquery.com/jquery-1.11.1.js"></script>
 
  <script>

    var hvemSkriverJegTil = "";
    //Via dropdown, vælger man hvem du skriver til.
    function vaeglVen() {
      hvemSkriverJegTil = document.getElementById("friendslist").value;
      console.log(document.getElementById("friendslist").value)
    }


    //Henter ens Venneliste over Request
    var venneliste = [];
    var xmlhttp = new XMLHttpRequest();

    xmlhttp.onreadystatechange = function () {
      if (this.readyState == 4 && this.status == 200) {
        console.log("inde i onreadystatechange")
        var myObj = JSON.parse(this.responseText);
        venneliste = myObj;

        var x = document.getElementById("friendslist");

        for (let index = 0; index < 4; index++) {
          let option = document.createElement("option");
          option.text = myObj.arr[index].name;
          x.add(option);
        }
      }
    };

    xmlhttp.open("GET", "http://192.168.43.116:3000/getChats", true);
    xmlhttp.send();
    console.log("venne " + venneliste);





    // Metode til at printe tidligere beskeder
    function printTidligereBeskeder() {
      //Vi henter beskederne
      var xmlhttp2 = new XMLHttpRequest();

      xmlhttp2.onreadystatechange = function () {
        // Hvis requested kommer til stadie 4(sendt), og får status 200(Alt ok), så kører loopet. 
        if (this.readyState == 4 && this.status == 200) {
          // Vi parser her resultatet til et json, fordi at den data vi henter fra myObj ikke er et rigtig json objekt.
          var myObj = JSON.parse(this.responseText);

          console.log(myObj.arr.length + " = Antal beskeder");

          // For at kunne printe beskederne, laver vi et array.
          // Da JSON objekter ikke har nogen længde, går vi ind i en array subgruppe, som tæller hvor mange pladser i arrayet, vi bruger.
          // Når vi så har det tal, kan vi lave et forloop, der printer beskeder, så længe der er nogen der ikke er printet endnu. 
          for (i = 0; i < myObj.arr.length; i++) {

            // Laver variabel, der bestemmer beskeden ud fra dens plads i arrayet.
            var text = myObj.arr[i].besked;
            // Tilføjer beskeden ud fra listen. 
            $('#messages').append($('<li>').text(text));
          }
        }
      }

      xmlhttp2.open("GET", "http://192.168.43.116:3000/getChat", true);
      xmlhttp2.send();
    }



    //Til at printe of sende beskeder.
    $(function () {
      var socket = io();

      //Spørger om dit brugernavn
      var username = prompt('Hvad er dit brugernavn ?');
      alert("Husk og vælg hvem du vil skrive med.")
      //var hvemSkriverJegTil = prompt("Hvem vil du skrive til?");


      //Når man connector til socket'en
      socket.emit('new_client', username);
      document.title = username + ' - ' + document.title;

      //Når vi sender beskeder.
      $('form').submit(function () {
        //socket.emit('chat message',username+' : '+ $('#m').val());
        //9:25 9/11 + mads : hej
        var tidDato = new Date().toLocaleTimeString('dk-DK',{hour12:false,hour:"numeric",minute:"numeric"})+ " "+new Date().toLocaleDateString();
        var hvadViSender = " "+ tidDato +" - "+username+" : " +$('#m').val() + " "
        socket.emit('chat message', hvemSkriverJegTil + hvadViSender);
        //$('#messages').append($('<li>').text($('#m').val()));
        $('#m').val('');
        return false;
      });

      //Når vi får beskeder. 
      socket.on('chat message', function (msg) {
        console.log("Her : " + msg.search(hvemSkriverJegTil))
        if (msg.search(username) > (-1)) {
          console.log(msg)
          if (msg.search(hvemSkriverJegTil) == 0) {
            var res = msg.replace(hvemSkriverJegTil, " ");
            $('#messages').append($('<li>').text(" " + res));
          } else {
            var res2 = msg.replace(username, " ");
            $('#messages').append($('<li>').text(" " + res2));
          }
        } else {
        }
      });
    });
  </script>
</body>

</html>